---
title: "Fish Taxa Table"
format: 
  html:
    theme: lux
    self-contained: true
    code-fold: true
    toc: true 
    toc-depth: 3
    toc-location: right
    number-sections: true
    number-depth: 3
---

```{r setup, message = F, warning = F, fig.width = 10, fig.height = 10, echo = F}
options(scipen = 999)

library(PristineSeasR)
library(bigrquery)
library(gt)
library(gtExtras)
library(tibble)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(plotly)
library(lubridate)

knitr::opts_chunk$set(eval = F, warning = F, message = F, include = F, echo = F)

ps_paths <- PristineSeasR::get_sci_drive_paths()

prj_path <- file.path(ps_paths$projects, "legacy-db")

ps_data_path <- ps_paths$datasets
  
bigrquery::bq_auth(email = "marine.data.science@ngs.org")

project_id <- "pristine-seas"

bq_connection <- DBI::dbConnect(bigrquery::bigquery(), 
                                project = project_id)
```

### Overview

The `taxonomy.fish` table is the authoritative reference for all fish taxa observed across Pristine Seas expeditions. It standardizes species names, taxonomic hierarchy, and ecological traits to support robust analysis, reporting, and integration across survey methods.

Each row corresponds to a unique accepted **AphiaID** from the World Register of Marine Species (WoRMS), and includes standardized scientific names, taxonomic hierarchy, common names, trophic group, length–weight parameters, and habitat traits.

This table supports three core functions:

  - ***Taxonomic resolution*** — reconciles field-recorded names with accepted nomenclature
  - ***Trait-based analysis*** — enables grouping by trophic group, functional guild, and life history traits
  - ***Cross-dataset integration*** — provides a consistent key (`accepted_aphia_id`) to link observations, field codes, and traits

Fish included here derive from underwater visual surveys (UVS), BRUV deployments, and regional species checklists compiled from both internal and external sources.

### Data Sources

The `taxonomy.fish` table integrates multiple authoritative sources to provide standardized taxonomy and ecological traits for all fish taxa recorded in Pristine Seas surveys. These include both internal field records and curated external databases:

- **Pristine Seas Field Records**  
  Taxa originate from diver-entered codes, annotated fieldbooks, and regional species lists compiled during UVS, BRUVS, and other fish survey methods. These records are harmonized and matched to valid WoRMS entries.

- **Akiona et al.**  
  A curated dataset of Pacific reef fishes, their length–weight parameters, and trophic classification, developed by researchers at Scripps Institution of Oceanography. This dataset provides key life history traits (e.g., maximum length, *a* and *b* coefficients) and has been manually corrected and standardized for integration.

- **World Register of Marine Species (WoRMS)**  
  Used as the taxonomic backbone. We query WoRMS to assign each taxon an accepted **AphiaID**, resolve synonyms, and retrieve the full taxonomic hierarchy (kingdom to species). All entries in `taxonomy.fish` correspond to a valid `accepted_aphia_id`.

- **FishBase (via `rfishbase`)**  
  Additional life history traits—such as common names, trophic levels, and ecological notes—are sourced from FishBase using automated queries. These supplement Akiona records and help fill gaps.

This combination of sources ensures a robust foundation for biodiversity analysis, trait-based modeling, and reproducible reporting.

### Construction Workflow

#### Taxonomy

These fields establish the taxonomic identity and lineage of each fish record in the database. All species are matched to their accepted **AphiaID** from the World Register of Marine Species (WoRMS), ensuring that taxonomy is standardized, traceable, and globally interoperable. Only accepted names are stored in this table — synonyms are handled upstream in the `uvs_fish_codes` table.

These fields enable joins with observation data, support grouping by taxonomic level, and form the basis for trait assignment.

```{r}
#| label: tbl-taxonomy-schema
#| tbl-cap: "Taxonomic lineage fields for fish taxa in the Pristine Seas Database"
#| 
core_taxonomy_schema <- tribble(
  ~name,             ~type,    ~description,
  "accepted_name",   "STRING", "Valid scientific name of the taxon (Genus species), according to WoRMS.",
  "accepted_aphia_id","INTEGER","Unique identifier for the accepted name from WoRMS.",
  "rank",            "STRING", "Taxonomic rank of the record (`species`, `genus`, or `family`).",
  "genus",           "STRING", "Genus of the accepted name.",
  "family",          "STRING", "Family of the accepted name.",
  "order",           "STRING", "Order of the accepted name.",
  "class",           "STRING", "Class of the accepted name.",
  "phylum",          "STRING", "Phylum of the accepted name.",
  "kingdom",         "STRING", "Kingdom of the accepted name."
)
core_taxonomy_schema
```

#### Common Names

This table includes standardized English names for species and families, supporting communication and summary outputs.

- `common_name`  
  The primary English common name for each species, sourced from FishBase and regional sources. Useful in reports, dashboards, and outreach materials.

- `common_family`  
  A standardized family-level label (e.g., *wrasses*, *groupers*, *parrotfishes*) used for aggregating results and summarizing broader ecological patterns.

These fields enable more intuitive summaries while retaining taxonomic precision.

```{r eval = TRUE, include=TRUE}
#| label: tbl-commmon-names-schema
#| tbl-cap: "Common names schema for fish taxa in the Pristine Seas Database"

common_name_schema <- tribble(
  ~name,               ~type,    ~description,
  "common_name",       "STRING", "Primary English common name for the species, standardized across sources.",
  "common_family",     "STRING", "Common name for the family (e.g., wrasses, groupers), used for broader summaries.") 

common_name_schema |> 
  gt() |> 
  tab_options(table.font.size = 13,
              table.border.top.style = "solid",
              table.border.top.width = px(2),
              table.border.top.color = "black",
              heading.align = "center",
              column_labels.font.weight = "bold")
```

#### Trophic Traits

Trophic traits help group species by their role in the food web, supporting ecological analysis and ecosystem-based management. All values are derived from FishBase or manually curated from the literature.

- `trophic_group`  
  Broad dietary classification used in Pristine Seas reports. One of: `herbivore/detritivore`, `planktivore`, `lower-carnivore`, `top-predator`, `shark`.

- `trophic_lvl`  
  Estimated numerical trophic level, from FishBase.

- `trophic_lvl_se`  
  Standard error of the trophic level estimate.

- `feeding_path`  
  Main foraging environment (e.g., `benthic`, `pelagic`, `non-feeding`).

- `feeding_type`  
  Foraging strategy (e.g., `ambush predator`, `filter feeder`).

- `diet`  
  Broad dietary category as provided by FishBase.

```{r}
#| label: tbl-trophic-schema
#| tbl-cap: "Schema for trophic traits in `taxonomy.fish`."
#| 
trophic_traits_schema <- tribble(
  ~name,             ~type,    ~description,
  "trophic_group",   "STRING", "Broad ecological role based on diet: herbivore/detritivore, planktivore, lower-carnivore, top-predator, shark.",
  "trophic_lvl",     "FLOAT",  "Estimated numeric trophic level (FishBase).",
  "trophic_lvl_se",  "FLOAT",  "Standard error of the trophic level estimate.",
  "feeding_path",    "STRING", "Dominant foraging environment (FishBase).",
  "feeding_type",    "STRING", "Behavioral feeding strategy (FishBase).",
  "diet",            "STRING", "Summary dietary category from FishBase."
)
```


#### Morphometrics

This section captures core length-weight relationships and body size metrics, essential for biomass estimation and life-history inference. Parameters are sourced from Akiona et al. (SIO), FishBase, or peer-reviewed literature.

- `tl_max`  
  Maximum total length (cm) observed or reported for the species.

- `tl_max_source`  
  Provenance of the max length (e.g., `FishBase`, `SIO`, `field`).

- `lw_a`, `lw_b`  
  Coefficients for the length-weight relationship: **W = a × Lᵇ**.

- `ltl_ratio`  
  Length-to-length conversion ratio, if applicable (e.g., SL to TL).

- `lw_length_type`  
  Type of length used in the equation (`TL`, `SL`, etc.).

- `lw_source`  
  Provenance of the length-weight parameters (`Akiona`, `FishBase`, `literature`).


```{r eval = TRUE, include=TRUE}
#| label: tbl-morphometrics-schema
#| tbl-cap: "Schema for morphometric traits in `taxonomy.fish`."

morphometrics_schema <- tribble(
  ~name,            ~type,    ~description,
  "tl_max",         "FLOAT",  "Maximum total length (TL) in cm.",
  "tl_max_source",  "STRING", "Source of max length (e.g., FishBase, SIO, field observation).",
  "lw_a",           "FLOAT",  "Coefficient 'a' in length-weight relationship: W = a × L^b.",
  "lw_b",           "FLOAT",  "Exponent 'b' in length-weight relationship: W = a × L^b.",
  "ltl_ratio",      "FLOAT",  "Length-to-length conversion ratio (if needed, e.g., SL to TL).",
  "lw_length_type", "STRING", "Type of length used in length-weight relationship (e.g., TL, SL).",
  "lw_source",      "STRING", "Source of length-weight parameters (e.g., FishBase, SIO, published study)."
)

morphometrics_schema |> 
  gt() |> 
  tab_options(table.font.size = 13,
              table.border.top.style = "solid",
              table.border.top.width = px(2),
              table.border.top.color = "black",
              heading.align = "center",
              column_labels.font.weight = "bold")
```


#### Habitat

Habitat classifications describe the typical spatial and ecological zone occupied by each species. These traits support analysis of habitat associations and community structure across reef and oceanic environments.

- `habitat_zone`  
  Broad habitat category based on FishBase definitions. One of:

  - `reef-associated`  
  - `benthopelagic`  
  - `demersal`  
  - `pelagic`  
  - `pelagic-neritic`  
  - `pelagic-oceanic`  
  - `bathypelagic`  
  - `bathydemersal`  
  - `unknown`

```{r}
#| label: tbl-habitat-schema
#| tbl-cap: "Schema for habitat trait fields in `taxonomy.fish`."

habitat_schema <- tribble(
  ~name,           ~type,    ~description,
  "habitat_zone",  "STRING", "Spatial habitat classification from FishBase. One of: 'reef-associated', 'benthopelagic', 'demersal', 'pelagic', 'pelagic-neritic', 'pelagic-oceanic', 'bathypelagic', 'bathydemersal', 'unknown'."
)
```

#### Fisheries Use

The `fisheries_use` field classifies each species by its importance to commercial and subsistence fisheries. This trait supports conservation planning, fisheries impact assessment, and identification of species with cultural or economic significance.

Values are sourced from the importance field in FishBase and, where needed, supplemented with expert and local knowledge from Pristine Seas expeditions.

```{r}
#| label: tbl-fisheries-schema
#| tbl-cap: "Fisheries use classification for fish taxa in the Pristine Seas Database."

fisheries_schema <- tribble(
  ~name,            ~type,    ~description,
  "fisheries_use",  "STRING", "FishBase classification of the species' importance to fisheries (e.g., 'minor commercial', 'subsistence fisheries', 'highly commercial', 'of no interest')."
)

fisheries_schema |> 
  gt() |> 
  tab_options(
    table.font.size = 13,
    table.border.top.style = "solid",
    table.border.top.width = px(2),
    table.border.top.color = "black",
    heading.align = "center",
    column_labels.font.weight = "bold"
  )
```

#### Conservation Status (IUCN)

The `taxonomy.fish` table includes fields derived from the IUCN Red List to support biodiversity assessments and conservation planning. Each species is matched to its most recent listing and assigned a standardized category (e.g., `LC`, `NT`, `VU`, `EN`, `CR`).

```{r}
#| label: tbl-tax-fish-iucn
#| tbl-cap: "IUCN Red List schema for fish taxonomy table"
#| 
iucn_schema <- tribble(
  ~name,       ~type,    ~description,
  "iucn_status", "STRING", "Global threat status from the IUCN Red List (e.g., 'Least Concern', 'Vulnerable', 'Endangered', etc.)."
)
```

### Summary

This section provides an overview of the composition of the `taxonomy.fish` table across key fields, supporting quick assessment of taxonomic coverage, trait completeness, and ecological representation.


#### Taxa by Family

#### Taxa by Trophic Group

#### Trait Completeness
